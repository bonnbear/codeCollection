
             
<template>
  <el-form ref="formRef" :model="formData" :rules="rules">
    <el-table ref="tableRef" :data="tableData" style="width: 100%" @cell-click="handleCellClick">
      <el-table-column v-for="column in columns" :key="column.prop" :label="column.label" :width="column.width">
        <template #default="scope">
          <el-form-item 
            :prop="`rows.${scope.$index}.${column.prop}.value`"
            :rules="rules[column.prop]"
            :class="{ 'is-error': showError(scope.$index, column.prop) }"
          >
            <!-- 非编辑状态 -->
            <div 
              v-if="!isEditing(scope.row, column.prop)" 
              class="cell-content"
              @click="handleCellContentClick(scope.row, column.prop, scope.$index, $event)"
            >
              <span :class="{ 'is-required': isRequired(column.prop) }">
                {{ formatCellValue(scope.row[column.prop].value, column.type, column.options) }}
              </span>
            </div>
            <!-- 编辑状态 -->
            <component
              v-else
              :is="getComponentByType(column.type)"
              v-model="scope.row[column.prop].value"
              v-bind="getComponentProps(column)"
              @blur="handleBlur"
              @change="handleChange"
              ref="inputRefs"
              :class="column.type"
            >
              <!-- select的选项 -->
              <template v-if="column.type === 'select'">
                <el-option
                  v-for="item in column.options"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                />
              </template>
            </component>
          </el-form-item>
        </template>
      </el-table-column>
    </el-table>
  </el-form>
</template>

<script setup>
import { ref, reactive, nextTick, onMounted, onUnmounted } from 'vue'
import { 
  ElTable, 
  ElTableColumn, 
  ElInput, 
  ElForm, 
  ElFormItem, 
  ElSelect, 
  ElOption, 
  ElDatePicker, 
  ElInputNumber, 
  ElSwitch 
} from 'element-plus'

// 列配置
const columns = [
  { 
    prop: 'date', 
    label: '日期', 
    width: '180', 
    required: true,
    type: 'date',
    format: 'YYYY-MM-DD',
    valueFormat: 'YYYY-MM-DD'
  },
  { 
    prop: 'name', 
    label: '姓名', 
    width: '180', 
    required: true,
    type: 'input'
  },
  { 
    prop: 'type', 
    label: '类型', 
    width: '180',
    required: true,
    type: 'select',
    options: [
      { value: '1', label: '类型一' },
      { value: '2', label: '类型二' },
      { value: '3', label: '类型三' }
    ]
  },
  { 
    prop: 'amount', 
    label: '金额', 
    width: '180',
    type: 'number',
    required: true,
    min: 0,
    max: 1000000,
    precision: 2,
    step: 0.1
  },
  { 
    prop: 'status', 
    label: '状态', 
    width: '100',
    type: 'switch'
  },
  { 
    prop: 'address', 
    label: '地址',
    type: 'input'
  }
]

const createEditableCell = (value) => reactive({
  value,
  isEditing: false
})

const tableData = ref([
  {
    date: createEditableCell('2016-05-03'),
    name: createEditableCell('张三'),
    type: createEditableCell('1'),
    amount: createEditableCell(100),
    status: createEditableCell(true),
    address: createEditableCell('浙江省杭州市西湖区')
  },
  {
    date: createEditableCell('2016-05-02'),
    name: createEditableCell('李四'),
    type: createEditableCell('2'),
    amount: createEditableCell(200),
    status: createEditableCell(false),
    address: createEditableCell('广东省深圳市南山区')
  }
])

// 表单数据模型
const formData = reactive({
  rows: tableData.value
})

// 验证规则
const rules = {
  date: [
    { required: true, message: '日期不能为空', trigger: 'change' }
  ],
  name: [
    { required: true, message: '姓名不能为空', trigger: 'blur' },
    { min: 2, max: 5, message: '长度在 2 到 5 个字符', trigger: 'blur' }
  ],
  type: [
    { required: true, message: '请选择类型', trigger: 'change' }
  ],
  amount: [
    { required: true, message: '请输入金额', trigger: 'change' },
    { type: 'number', min: 0, max: 1000000, message: '金额必须在0-1000000之间', trigger: 'change' }
  ]
}

// 获取编辑组件类型
const getComponentByType = (type) => {
  const componentMap = {
    'input': ElInput,
    'select': ElSelect,
    'date': ElDatePicker,
    'number': ElInputNumber,
    'switch': ElSwitch
  }
  return componentMap[type] || ElInput
}

// 获取组件属性
const getComponentProps = (column) => {
  const commonProps = {
    style: { width: '100%' }
  }

  const propsMap = {
    'date': {
      type: column.dateType || 'date',
      format: column.format,
      valueFormat: column.valueFormat || 'YYYY-MM-DD',
      ...commonProps
    },
    'number': {
      min: column.min,
      max: column.max,
      precision: column.precision,
      step: column.step || 1,
      ...commonProps
    },
    'select': commonProps,
    'input': commonProps,
    'switch': {}
  }

  return propsMap[column.type] || commonProps
}

const formatCellValue = (value, type, options) => {
  if (value === null || value === undefined) return ''
  
  switch (type) {
    case 'select':
      return options?.find(opt => opt.value === value)?.label || value
    case 'switch':
      return value ? '是' : '否'
    default:
      return value
  }
}

const formRef = ref(null)
const inputRefs = ref([])
const currentEditingCell = ref(null)
const tableRef = ref(null)

const isRequired = (prop) => {
  return columns.find(col => col.prop === prop)?.required
}

const showError = (index, prop) => {
  const errors = formRef.value?.errors
  const fieldName = `rows.${index}.${prop}.value`
  return errors && errors[fieldName]
}

const isEditing = (row, prop) => {
  return currentEditingCell.value && 
         currentEditingCell.value.row === row && 
         currentEditingCell.value.prop === prop
}

// 处理单元格内容点击
const handleCellContentClick = (row, prop, index, event) => {
  event.stopPropagation() // 阻止事件冒泡
  const column = columns.find(col => col.prop === prop)
  
  // 如果是开关类型，直接切换值
  if (column.type === 'switch') {
    row[prop].value = !row[prop].value
    return
  }

  // 如果已经在编辑状态，则不做任何操作
  if (isEditing(row, prop)) {
    return
  }

  startEdit(row, prop, index)
}

const startEdit = (row, prop, index) => {
  if (currentEditingCell.value) {
    finishEdit()
  }
  currentEditingCell.value = { row, prop, index }
  nextTick(() => {
    const input = inputRefs.value.find(el => el && el.$el.contains(document.activeElement))
    if (input) {
      input.focus()
    }
  })
}

const finishEdit = async () => {
  if (currentEditingCell.value) {
    const { index, prop } = currentEditingCell.value
    try {
      await formRef.value?.validateField(`rows.${index}.${prop}.value`)
      currentEditingCell.value = null
    } catch (error) {
      return
    }
  }
}

// 处理单元格点击
const handleCellClick = (row, column, cell, event) => {
  // 如果点击的是当前编辑的单元格，不做任何操作
  if (currentEditingCell.value && 
      currentEditingCell.value.row === row && 
      currentEditingCell.value.prop === column.property) {
    return
  }

  // 如果点击的是其他单元格，结束当前编辑
  if (currentEditingCell.value) {
    finishEdit()
  }
}

// 处理失去焦点
const handleBlur = () => {
  // 使用 setTimeout 确保在处理 click 事件之后执行
  setTimeout(() => {
    if (currentEditingCell.value && !isClickInsideComponent()) {
      finishEdit()
    }
  }, 200)
}

// 处理值变化
const handleChange = () => {
  const column = columns.find(col => col.prop === currentEditingCell.value?.prop)
  // 对于 select 和 date 类型，值变化后直接完成编辑
  if (column && (column.type === 'select' || column.type === 'date')) {
    finishEdit()
  }
}

// 检查点击是否在组件内部
const isClickInsideComponent = () => {
  if (!currentEditingCell.value) return false
  
  const activeElement = document.activeElement
  const inputs = inputRefs.value
  
  return inputs.some(input => {
    if (!input?.$el) return false
    return input.$el.contains(activeElement) || 
           // 检查下拉面板
           document.querySelector('.el-select-dropdown')?.contains(activeElement) ||
           document.querySelector('.el-picker__popper')?.contains(activeElement)
  })
}

const handleGlobalClick = (event) => {
  if (currentEditingCell.value && tableRef.value) {
    const tableEl = tableRef.value.$el
    if (tableEl && !tableEl.contains(event.target)) {
      finishEdit()
    }
  }
}

// 添加新行
const addRow = () => {
  tableData.value.push({
    date: createEditableCell(''),
    name: createEditableCell(''),
    type: createEditableCell(''),
    amount: createEditableCell(0),
    status: createEditableCell(false),
    address: createEditableCell('')
  })
}

// 删除行
const removeRow = (index) => {
  tableData.value.splice(index, 1)
}

// 验证并提交数据
const submitData = async () => {
  try {
    await formRef.value.validate()
    const formattedData = tableData.value.map(row => {
      const newRow = {}
      for (const key in row) {
        newRow[key] = row[key].value
      }
      return newRow
    })
    console.log('提交的数据：', formattedData)
    return formattedData
  } catch (error) {
    console.log('验证失败')
    return false
  }
}

onMounted(() => {
  nextTick(() => {
    document.addEventListener('click', handleGlobalClick)
  })
})

onUnmounted(() => {
  document.removeEventListener('click', handleGlobalClick)
})

// 暴露方法供父组件使用
defineExpose({
  addRow,
  removeRow,
  submitData,
  validateTable: () => formRef.value.validate()
})
</script>

<style scoped>
.el-table .cell {
  line-height: 23px;
}

.is-required:not(.el-form-item--error):before {
  content: "*";
  color: #f56c6c;
  margin-right: 4px;
}

.el-form-item.is-error {
  margin-bottom: 0;
}

.el-form-item.is-error .el-input__wrapper,
.el-form-item.is-error .el-select .el-input__wrapper,
.el-form-item.is-error .el-date-editor.el-input__wrapper {
  box-shadow: 0 0 0 1px #f56c6c inset;
}

.cell-content {
  cursor: pointer;
  width: 100%;
  height: 100%;
}

/* 编辑状态下的控件样式 */
:deep(.el-select),
:deep(.el-date-editor),
:deep(.el-input-number) {
  width: 100%;
}

:deep(.el-input__wrapper) {
  width: 100%;
}

/* 确保开关在单元格中居中显示 */
:deep(.el-switch) {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}
</style>
