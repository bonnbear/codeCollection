<template>
  <div class="app-container">
    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="header-section">
      <h2>æƒé™ç®¡ç†</h2>
      <el-button @click="restartTour" type="primary" size="small">
        <el-icon><Refresh /></el-icon>
        é‡æ–°æŸ¥çœ‹å¼•å¯¼
      </el-button>
    </div>

    <!-- æƒé™é€‰æ‹©åŒºåŸŸ -->
    <div class="permission-section">
      <div class="form-item">
        <label class="form-label">
          é€‰æ‹©æƒé™
          <el-badge v-if="hasNewPermission" is-dot class="permission-badge">
            <el-icon color="#409EFF"><InfoFilled /></el-icon>
          </el-badge>
        </label>
        
        <el-select
          ref="permissionSelectRef"
          v-model="selectedPermission"
          placeholder="è¯·é€‰æ‹©æƒé™"
          class="permission-select"
          :popper-class="tourActive ? 'tour-select-dropdown' : ''"
          @change="handlePermissionChange"
          @visible-change="handleVisibleChange"
        >
          <el-option
            v-for="item in permissions"
            :key="item.value"
            :label="item.label"
            :value="item.value"
            :class="{ 'highlighted-option': item.isNew && tourActive }"
          >
            <div class="option-content">
              <span>{{ item.label }}</span>
              <el-tag v-if="item.isNew" type="danger" size="small" effect="plain">
                æ–°å¢
              </el-tag>
            </div>
          </el-option>
        </el-select>
      </div>

      <div class="selected-info" v-if="selectedPermission">
        <el-alert
          :title="`å½“å‰é€‰æ‹©: ${getPermissionLabel(selectedPermission)}`"
          type="info"
          :closable="false"
        />
      </div>
    </div>

    <!-- 
      ã€å…³é”®ä¿®æ­£ã€‘: ç§»é™¤äº†æ¨¡æ¿ä¸­å¯¼è‡´è§£æé”™è¯¯çš„ä¸­æ–‡æ³¨é‡Šã€‚
      ç›¸å…³å±æ€§çš„è§£é‡Šå·²ç§»è‡³ <script> éƒ¨åˆ†ã€‚
    -->
    <el-popover
      ref="popoverRef"
      :visible="popoverVisible"
      trigger="manual"
      effect="light"
      placement="right"
      :virtual-ref="popoverVirtualRef"
      virtual-triggering
      :popper-options="popperOptions"
      :width="300"
      :persistent="true"
      :hide-after="0"
    >
      <div class="guide-content">
        <h4>ğŸ‰ æ–°æƒé™æé†’</h4>
        <p>ç³»ç»Ÿæ–°å¢äº†â€œè¶…çº§ç®¡ç†å‘˜â€æƒé™ï¼Œè¯·åœ¨ä¸‹æ–¹å±•å¼€çš„åˆ—è¡¨ä¸­ç‚¹å‡»é€‰æ‹©ã€‚</p>
        <el-button type="primary" size="small" @click="handlePopoverClose">
          çŸ¥é“äº†
        </el-button>
      </div>
    </el-popover>

    <!-- é®ç½©å±‚ -->
    <div v-if="tourActive" class="tour-mask"></div>
  </div>
</template>

<script setup>
import { ref, onMounted, nextTick, onUnmounted } from 'vue'
import { ElMessage } from 'element-plus'
import { Refresh, InfoFilled } from '@element-plus/icons-vue'

const permissionSelectRef = ref(null)
const popoverRef = ref(null) 

const selectedPermission = ref('')
const hasNewPermission = ref(true)
const tourActive = ref(false)

const popoverVisible = ref(false)
const popoverVirtualRef = ref(null)

const popperOptions = {
  strategy: 'fixed',
  modifiers: [{ name: 'offset', options: { offset: [0, 12] } }],
}

const permissions = ref([
  { value: 'read', label: 'åªè¯»æƒé™', isNew: false },
  { value: 'write', label: 'ç¼–è¾‘æƒé™', isNew: false },
  { value: 'delete', label: 'åˆ é™¤æƒé™', isNew: false },
  { value: 'admin', label: 'ç®¡ç†å‘˜æƒé™', isNew: false },
  { value: 'super_admin', label: 'è¶…çº§ç®¡ç†å‘˜', isNew: true }
])

const getPermissionLabel = (value) => {
  const p = permissions.value.find(p => p.value === value)
  return p ? p.label : ''
}

const startTour = async () => {
  tourActive.value = true
  popoverVisible.value = false
  await nextTick()

  if (permissionSelectRef.value) {
    popoverVirtualRef.value = permissionSelectRef.value.$el
    popoverVisible.value = true

    permissionSelectRef.value.visible = true

    await nextTick()
    scrollToNewOption()
  }
}

const handleVisibleChange = (visible) => {
  if (tourActive.value && !visible) {
    setTimeout(() => {
      if (permissionSelectRef.value) {
        permissionSelectRef.value.visible = true
      }
    }, 0)
  }
}

const scrollToNewOption = () => {
  const dropdown = document.querySelector('.tour-select-dropdown')
  const newOption = dropdown?.querySelector('.highlighted-option')
  if (newOption) {
    newOption.scrollIntoView({ behavior: 'smooth', block: 'center' })
  }
}

const restartTour = () => {
  if (permissionSelectRef.value) {
    permissionSelectRef.value.visible = false
  }
  hasNewPermission.value = true
  permissions.value.forEach(p => {
    if (p.value === 'super_admin') p.isNew = true
  })
  selectedPermission.value = ''
  popoverVisible.value = false
  tourActive.value = false

  setTimeout(() => startTour(), 300)
}

// ç»“æŸå¼•å¯¼çš„æ ¸å¿ƒå‡½æ•°
const handlePopoverClose = () => {
  tourActive.value = false 
  popoverVisible.value = false 

  if (permissionSelectRef.value) {
    permissionSelectRef.value.visible = false
  }

  ElMessage.success('å¼•å¯¼å·²å®Œæˆï¼Œæ‚¨å¯ä»¥éšæ—¶é€‰æ‹©æ–°æƒé™')
  localStorage.setItem('permission_tour_viewed', 'true')
}

const handlePermissionChange = (value) => {
  const p = permissions.value.find(p => p.value === value)
  if (p && p.isNew) {
    ElMessage.success(`æ‚¨å·²é€‰æ‹©æ–°æƒé™: ${p.label}`)
    p.isNew = false
    hasNewPermission.value = false
    
    if (tourActive.value) {
      handlePopoverClose()
    }
  }
}

const handleResize = () => {
  if (popoverVisible.value) {
    popoverRef.value?.updatePopper?.()
  }
}

onMounted(() => {
  const tourViewed = localStorage.getItem('permission_tour_viewed')
  if (!tourViewed) {
    setTimeout(() => startTour(), 500)
  }
  window.addEventListener('resize', handleResize)
})

onUnmounted(() => {
  window.removeEventListener('resize', handleResize)
})
</script>

<style scoped>
/* æ‰€æœ‰æ ·å¼ä¿æŒä¸å˜ */
.app-container {
  padding: 20px;
  max-width: 800px;
  margin: 0 auto;
  position: relative;
}
.header-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 15px;
  border-bottom: 1px solid #e4e7ed;
}
.header-section h2 { margin: 0; color: #303133; }
.permission-section {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
  position: relative;
  z-index: 1001; 
}
.form-item { margin-bottom: 20px; }
.form-label {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
  font-size: 14px;
  color: #606266;
  font-weight: 500;
}
.permission-badge { margin-left: 5px; }
.permission-badge :deep(.el-badge__content) {
  background-color: #f56c6c;
  animation: pulse 2s infinite;
}
.permission-select { width: 100%; }
.option-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}
.selected-info { margin-top: 20px; }
.guide-content h4 { margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #303133; }
.guide-content p { margin: 0 0 12px 0; font-size: 14px; line-height: 1.5; color: #606266; }
.tour-mask {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.3);
  z-index: 1000;
  animation: fadeIn 0.2s ease;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}
</style>

<style>
/* å…¨å±€æ ·å¼ä¹Ÿä¿æŒä¸å˜ */
.tour-select-dropdown { z-index: 3001 !important; }
.tour-select-dropdown .highlighted-option {
  background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%) !important;
  position: relative;
  animation: highlightPulse 2s ease-in-out infinite;
}
.tour-select-dropdown .highlighted-option::before {
  content: 'ğŸ‘‰';
  position: absolute;
  left: -25px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 20px;
  animation: pointing 1s ease-in-out infinite;
}
@keyframes highlightPulse {
  0%, 100% { 
    background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
    box-shadow: inset 0 0 0 2px rgba(251, 191, 36, 0.3);
  }
  50% { 
    background: linear-gradient(90deg, #fed7aa 0%, #fbbf24 100%);
    box-shadow: inset 0 0 0 2px rgba(251, 191, 36, 0.5);
  }
}
@keyframes pointing {
  0%, 100% { transform: translateY(-50%) translateX(0); }
  50% { transform: translateY(-50%) translateX(5px); }
}
.el-select-dropdown__item.highlighted-option:hover {
  background: linear-gradient(90deg, #fed7aa 0%, #fbbf24 100%) !important;
}
</style>
