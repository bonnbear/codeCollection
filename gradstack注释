<script setup>
// ============================================================
// å¯¼å…¥ä¾èµ–
// ============================================================
import { ref, onMounted, onBeforeUnmount, nextTick } from 'vue'
// ref: åˆ›å»ºå“åº”å¼å¼•ç”¨
// onMounted: ç»„ä»¶æŒ‚è½½åæ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸé’©å­
// onBeforeUnmount: ç»„ä»¶å¸è½½å‰æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸé’©å­
// nextTick: ç­‰å¾… DOM æ›´æ–°å®Œæˆåæ‰§è¡Œå›è°ƒ

import { GridStack } from 'gridstack'
// GridStack: ä¸€ä¸ªå¯æ‹–æ‹½ã€å¯è°ƒæ•´å¤§å°çš„ç½‘æ ¼å¸ƒå±€åº“
// å®˜ç½‘: https://gridstackjs.com/

import 'gridstack/dist/gridstack.min.css'
// å¼•å…¥ GridStack çš„åŸºç¡€æ ·å¼

// ============================================================
// å¸¸é‡å®šä¹‰
// ============================================================
const LS_KEY = 'gridstack-layout'
// localStorage å­˜å‚¨é”®åï¼Œç”¨äºæŒä¹…åŒ–ä¿å­˜ç”¨æˆ·çš„å¸ƒå±€é…ç½®

// ============================================================
// å“åº”å¼æ•°æ® (Reactive State)
// ============================================================
const gridRef = ref(null)
// ç½‘æ ¼å®¹å™¨çš„ DOM å¼•ç”¨ï¼Œé€šè¿‡ template ä¸­çš„ ref="gridRef" ç»‘å®š
// ç”¨äº GridStack åˆå§‹åŒ–å’ŒæŸ¥è¯¢å­å…ƒç´ 

const gsItems = ref([])
// å­˜å‚¨æ‰€æœ‰å¡ç‰‡æ•°æ®çš„å“åº”å¼æ•°ç»„
// æ¯ä¸ªå¡ç‰‡å¯¹è±¡åŒ…å«: { id, x, y, w, h, title, content }
// - id: å”¯ä¸€æ ‡è¯†ç¬¦
// - x, y: ç½‘æ ¼ä¸­çš„ä½ç½®åæ ‡
// - w, h: å®½åº¦å’Œé«˜åº¦ï¼ˆä»¥ç½‘æ ¼å•å…ƒä¸ºå•ä½ï¼‰
// - title: å¡ç‰‡æ ‡é¢˜
// - content: å¡ç‰‡å†…å®¹

const addCount = ref(1)
// æ‰¹é‡æ·»åŠ æ—¶çš„æ•°é‡ï¼Œç»‘å®šåˆ°è¾“å…¥æ¡†çš„ v-model

// ============================================================
// GridStack å®ä¾‹ç›¸å…³
// ============================================================
let grid = null
// GridStack å®ä¾‹ï¼Œéå“åº”å¼ï¼ˆå› ä¸ºä¸éœ€è¦è§¦å‘è§†å›¾æ›´æ–°ï¼‰
// åœ¨ onMounted ä¸­åˆå§‹åŒ–ï¼Œåœ¨ onBeforeUnmount ä¸­é”€æ¯

let gsCounter = Date.now()
// ID è®¡æ•°å™¨ï¼Œä½¿ç”¨å½“å‰æ—¶é—´æˆ³ä½œä¸ºåˆå§‹å€¼
// ç¡®ä¿ç”Ÿæˆçš„ ID å”¯ä¸€ä¸”é€’å¢

/**
 * ç”Ÿæˆå”¯ä¸€ ID
 * @returns {string} å”¯ä¸€çš„å­—ç¬¦ä¸² ID
 * 
 * ä½¿ç”¨é€’å¢è®¡æ•°å™¨è€Œééšæœºæ•°ï¼Œç¡®ä¿ï¼š
 * 1. ID æ°¸è¿œå”¯ä¸€
 * 2. ID å¯é¢„æµ‹ï¼Œä¾¿äºè°ƒè¯•
 * 3. æ–°å¡ç‰‡çš„ ID æ€»æ˜¯å¤§äºç°æœ‰å¡ç‰‡
 */
function generateId() {
  return String(gsCounter++)
}

// ============================================================
// é»˜è®¤å¸ƒå±€é…ç½®
// ============================================================
const defaultLayout = [
  { id: '1', x: 0, y: 0, w: 2, h: 2, title: 'å¡ç‰‡ 1', content: 'å…§å®¹ 1' },
  { id: '2', x: 2, y: 0, w: 2, h: 2, title: 'å¡ç‰‡ 2', content: 'å…§å®¹ 2' },
  { id: '3', x: 4, y: 0, w: 2, h: 2, title: 'å¡ç‰‡ 3', content: 'å…§å®¹ 3' },
]
// åˆå§‹åŠ è½½å’Œé‡ç½®æ—¶ä½¿ç”¨çš„é»˜è®¤å¸ƒå±€
// ç½‘æ ¼å…± 12 åˆ—ï¼Œè¿™é‡Œæ”¾ç½®äº† 3 ä¸ª 2Ã—2 çš„å¡ç‰‡å¹¶æ’æ˜¾ç¤º

// ============================================================
// å·¥å…·å‡½æ•° (Utility Functions)
// ============================================================

/**
 * å®‰å…¨è§£æ JSON æ•°ç»„
 * @param {string} raw - åŸå§‹ JSON å­—ç¬¦ä¸²
 * @returns {Array} è§£æåçš„æ•°ç»„ï¼Œè§£æå¤±è´¥è¿”å›ç©ºæ•°ç»„
 * 
 * é˜²å¾¡æ€§ç¼–ç¨‹ï¼š
 * 1. æ•è· JSON.parse å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸
 * 2. éªŒè¯è§£æç»“æœç¡®å®æ˜¯æ•°ç»„
 */
function safeParseArray(raw) {
  try {
    const data = JSON.parse(raw)
    return Array.isArray(data) ? data : []
  } catch {
    return []
  }
}

/**
 * é”€æ¯ GridStack ä¸­çš„æ‰€æœ‰ widgetï¼ˆä½†ä¿ç•™ DOMï¼‰
 * 
 * å‚æ•°è¯´æ˜ï¼š
 * - grid.removeAll(false): false è¡¨ç¤ºä¸ç§»é™¤ DOM å…ƒç´ 
 *   ä»…ä» GridStack çš„ç®¡ç†ä¸­ç§»é™¤è¿™äº› widget
 *   DOM å…ƒç´ ç”± Vue çš„ v-for æ§åˆ¶
 */
function destroyGridstackWidgetsOnly() {
  if (grid) {
    grid.removeAll(false)
  }
}

/**
 * æ‰¹é‡å°† DOM å…ƒç´ æ³¨å†Œä¸º GridStack widget
 * 
 * å·¥ä½œæµç¨‹ï¼š
 * 1. batchUpdate() - å¼€å§‹æ‰¹é‡æ›´æ–°æ¨¡å¼ï¼Œæš‚åœå¸ƒå±€è®¡ç®—
 * 2. éå† gsItemsï¼Œä¸ºæ¯ä¸ªå¡ç‰‡çš„ DOM è°ƒç”¨ makeWidget()
 * 3. batchUpdate(false) - ç»“æŸæ‰¹é‡æ¨¡å¼ï¼Œä¸€æ¬¡æ€§é‡æ–°è®¡ç®—å¸ƒå±€
 * 
 * æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡æ“ä½œé¿å…å¤šæ¬¡é‡æ’ï¼Œæå‡æ€§èƒ½
 */
function batchMakeWidgets() {
  if (!grid || !gridRef.value) return

  grid.batchUpdate() // å¼€å§‹æ‰¹é‡æ¨¡å¼

  gsItems.value.forEach((it) => {
    // é€šè¿‡ gs-id å±æ€§æŸ¥æ‰¾å¯¹åº”çš„ DOM å…ƒç´ 
    const el = gridRef.value.querySelector(`[gs-id="${it.id}"]`)
    if (!el) return
    
    // makeWidget() å°†æ™®é€š DOM å…ƒç´ è½¬æ¢ä¸ºå¯æ‹–æ‹½/è°ƒæ•´å¤§å°çš„ widget
    grid.makeWidget(el)
  })

  grid.batchUpdate(false) // ç»“æŸæ‰¹é‡æ¨¡å¼ï¼Œè§¦å‘å¸ƒå±€é‡ç®—
}

/**
 * ä» GridStack åŒæ­¥ä½ç½®æ•°æ®åˆ° Vue å“åº”å¼æ•°æ®
 * 
 * ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
 * ç”¨æˆ·æ‹–æ‹½å¡ç‰‡åï¼ŒGridStack å†…éƒ¨çŠ¶æ€ä¼šæ›´æ–°
 * ä½† Vue çš„ gsItems ä¸ä¼šè‡ªåŠ¨åŒæ­¥
 * è¿™ä¸ªå‡½æ•°æ‰‹åŠ¨å°† GridStack çš„çŠ¶æ€åŒæ­¥åˆ° Vue
 * 
 * gridstackNode: GridStack åœ¨æ¯ä¸ª DOM å…ƒç´ ä¸Šé™„åŠ çš„çŠ¶æ€å¯¹è±¡
 */
function syncFromGridstack() {
  if (!grid) return

  // è·å–æ‰€æœ‰è¢« GridStack ç®¡ç†çš„ DOM å…ƒç´ 
  const nodes = grid.getGridItems()
  
  nodes.forEach((el) => {
    const node = el.gridstackNode // è·å– GridStack é™„åŠ çš„èŠ‚ç‚¹æ•°æ®
    if (!node) return

    // åœ¨ Vue æ•°æ®ä¸­æ‰¾åˆ°å¯¹åº”çš„å¡ç‰‡å¹¶æ›´æ–°ä½ç½®/å°ºå¯¸
    const item = gsItems.value.find((it) => it.id === node.id)
    if (item) {
      item.x = node.x
      item.y = node.y
      item.w = node.w
      item.h = node.h
    }
  })
}

/**
 * ä½¿ç”¨æ–°æ•°æ®å®Œå…¨é‡æ–°åŠ è½½å¸ƒå±€
 * @param {Array} data - æ–°çš„å¸ƒå±€æ•°æ®æ•°ç»„
 * 
 * æ‰§è¡Œæ­¥éª¤ï¼š
 * 1. ä» GridStack ç§»é™¤æ‰€æœ‰ç°æœ‰ widget
 * 2. æ¸…ç©º Vue å“åº”å¼æ•°ç»„
 * 3. ç­‰å¾… DOM æ›´æ–°ï¼ˆVue ä¼šç§»é™¤æ—§çš„ DOM å…ƒç´ ï¼‰
 * 4. è®¾ç½®æ–°æ•°æ®
 * 5. æ›´æ–° ID è®¡æ•°å™¨ï¼ˆé˜²æ­¢ ID å†²çªï¼‰
 * 6. ç­‰å¾… DOM æ›´æ–°ï¼ˆVue ä¼šåˆ›å»ºæ–°çš„ DOM å…ƒç´ ï¼‰
 * 7. å°†æ–°çš„ DOM å…ƒç´ æ³¨å†Œä¸º GridStack widget
 */
async function reloadLayoutWithData(data) {
  destroyGridstackWidgetsOnly()

  gsItems.value = [] // æ¸…ç©ºï¼Œè§¦å‘ Vue ç§»é™¤æ‰€æœ‰å¡ç‰‡ DOM
  await nextTick()   // ç­‰å¾… DOM æ›´æ–°å®Œæˆ

  // è§„èŒƒåŒ–æ•°æ®ï¼šç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æœ‰å€¼
  gsItems.value = data.map((it) => ({
    id: String(it.id),          // ç¡®ä¿ ID æ˜¯å­—ç¬¦ä¸²
    x: it.x,
    y: it.y,
    w: it.w,
    h: it.h,
    title: it.title ?? `å¡ç‰‡ ${it.id}`,  // ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦
    content: it.content ?? '',
  }))

  updateCounterFromItems() // æ›´æ–°è®¡æ•°å™¨ï¼Œé˜²æ­¢æ–°å¢æ—¶ ID å†²çª
  await nextTick()         // ç­‰å¾…æ–° DOM åˆ›å»º
  batchMakeWidgets()       // æ³¨å†Œä¸º GridStack widget
}

/**
 * æ ¹æ®ç°æœ‰å¡ç‰‡ ID æ›´æ–°è®¡æ•°å™¨
 * 
 * ç›®çš„ï¼šé˜²æ­¢æ–°ç”Ÿæˆçš„ ID ä¸å·²å­˜åœ¨çš„ ID å†²çª
 * 
 * å·¥ä½œåŸç†ï¼š
 * 1. æå–æ‰€æœ‰æ•°å­—ç±»å‹çš„ ID
 * 2. æ‰¾å‡ºæœ€å¤§å€¼
 * 3. å¦‚æœè®¡æ•°å™¨ <= æœ€å¤§å€¼ï¼Œåˆ™æ›´æ–°è®¡æ•°å™¨ä¸º æœ€å¤§å€¼ + 1
 */
function updateCounterFromItems() {
  const nums = gsItems.value
    .map((it) => parseInt(it.id, 10))  // å°è¯•è½¬ä¸ºæ•°å­—
    .filter((n) => !isNaN(n))           // è¿‡æ»¤æ— æ•ˆæ•°å­—

  if (nums.length > 0) {
    const maxId = Math.max(...nums)
    if (gsCounter <= maxId) {
      gsCounter = maxId + 1
    }
  }
}

// ============================================================
// æ“ä½œå‡½æ•° (Action Functions)
// ============================================================

/**
 * æ‰¹é‡æ·»åŠ å¡ç‰‡
 * @param {number} count - è¦æ·»åŠ çš„å¡ç‰‡æ•°é‡ï¼ˆ1-20ï¼‰
 * 
 * æ‰§è¡Œæ­¥éª¤ï¼š
 * 1. éªŒè¯å¹¶é™åˆ¶æ•°é‡èŒƒå›´
 * 2. åˆ›å»ºæ–°å¡ç‰‡æ•°æ®å¯¹è±¡
 * 3. æ·»åŠ åˆ° Vue å“åº”å¼æ•°ç»„
 * 4. ç­‰å¾… DOM åˆ›å»º
 * 5. æ‰¹é‡æ³¨å†Œä¸º GridStack widget
 * 6. è¯»å– GridStack è‡ªåŠ¨è®¡ç®—çš„ä½ç½®å¹¶æ›´æ–°åˆ° Vue æ•°æ®
 * 
 * æ³¨æ„ï¼šæ–°å¡ç‰‡çš„ x, y ä½ç½®ç”± GridStack è‡ªåŠ¨è®¡ç®—ï¼ˆfloat: false æ¨¡å¼ä¸‹ä¼šè‡ªåŠ¨å †å ï¼‰
 */
async function addItems(count = 1) {
  const validCount = Math.max(1, Math.min(count, 20)) // é™åˆ¶èŒƒå›´ 1-20
  const newItems = []

  // æ­¥éª¤ 1: åˆ›å»ºæ‰€æœ‰æ–°å¡ç‰‡çš„æ•°æ®å¯¹è±¡
  for (let i = 0; i < validCount; i++) {
    const id = generateId()
    newItems.push({
      id,
      w: 2,           // é»˜è®¤å®½åº¦ 2 ä¸ªç½‘æ ¼å•å…ƒ
      h: 2,           // é»˜è®¤é«˜åº¦ 2 ä¸ªç½‘æ ¼å•å…ƒ
      title: `å¡ç‰‡ ${id}`,
      content: '',
      // æ³¨æ„ï¼šä¸è®¾ç½® x, yï¼Œè®© GridStack è‡ªåŠ¨è®¡ç®—ä½ç½®
    })
  }

  // æ­¥éª¤ 2: æ·»åŠ åˆ°å“åº”å¼æ•°ç»„
  gsItems.value.push(...newItems)
  
  // æ­¥éª¤ 3: ç­‰å¾… Vue æ›´æ–° DOMï¼ˆv-for ä¼šåˆ›å»ºæ–°çš„å¡ç‰‡å…ƒç´ ï¼‰
  await nextTick()

  // æ­¥éª¤ 4: å°†æ–°åˆ›å»ºçš„ DOM å…ƒç´ æ³¨å†Œä¸º GridStack widget
  if (grid && gridRef.value) {
    grid.batchUpdate() // å¼€å§‹æ‰¹é‡æ¨¡å¼

    newItems.forEach((newItem) => {
      // æŸ¥æ‰¾æ–°åˆ›å»ºçš„ DOM å…ƒç´ 
      const el = gridRef.value.querySelector(`[gs-id="${newItem.id}"]`)
      if (el) {
        grid.makeWidget(el) // æ³¨å†Œä¸º widget

        // è¯»å– GridStack è®¡ç®—çš„ä½ç½®ï¼Œæ›´æ–°åˆ° Vue æ•°æ®
        // è¿™æ · Vue æ¨¡æ¿ä¸­æ˜¾ç¤ºçš„ä½ç½®ä¿¡æ¯æ‰æ˜¯å‡†ç¡®çš„
        const node = el.gridstackNode
        if (node) {
          newItem.x = node.x
          newItem.y = node.y
          newItem.w = node.w
          newItem.h = node.h
        }
      }
    })

    grid.batchUpdate(false) // ç»“æŸæ‰¹é‡æ¨¡å¼
  }
}

/**
 * æ·»åŠ å•ä¸ªå¡ç‰‡ï¼ˆä¾¿æ·æ–¹æ³•ï¼‰
 */
async function addItem() {
  await addItems(1)
}

/**
 * æ ¹æ®è¾“å…¥æ¡†çš„æ•°é‡æ·»åŠ å¤šä¸ªå¡ç‰‡
 */
async function addMultipleItems() {
  await addItems(addCount.value)
}

/**
 * åˆ é™¤æŒ‡å®š ID çš„å¡ç‰‡
 * @param {string} id - è¦åˆ é™¤çš„å¡ç‰‡ ID
 * 
 * æ‰§è¡Œæ­¥éª¤ï¼š
 * 1. åœ¨æ•°ç»„ä¸­æŸ¥æ‰¾å¡ç‰‡ç´¢å¼•
 * 2. ä» GridStack ç§»é™¤ widgetï¼ˆä¿ç•™ DOM è®© Vue å¤„ç†ï¼‰
 * 3. ä» Vue æ•°ç»„ä¸­ç§»é™¤ï¼ˆè§¦å‘ DOM ç§»é™¤ï¼‰
 * 4. åŒæ­¥å…¶ä»–å¡ç‰‡çš„ä½ç½®ï¼ˆå› ä¸ºåˆ é™¤åå¯èƒ½ä¼šè§¦å‘é‡æ’ï¼‰
 */
function removeItem(id) {
  const idx = gsItems.value.findIndex((it) => it.id === id)
  if (idx === -1) return // æ‰¾ä¸åˆ°åˆ™é€€å‡º

  // æŸ¥æ‰¾å¯¹åº”çš„ DOM å…ƒç´ 
  const el = gridRef.value?.querySelector(`[gs-id="${id}"]`)

  if (el && grid) {
    // removeWidget(el, false): false è¡¨ç¤ºä¸ç§»é™¤ DOM
    // DOM çš„ç§»é™¤ç”± Vue çš„å“åº”å¼ç³»ç»Ÿå¤„ç†
    grid.removeWidget(el, false)
  }

  // ä» Vue æ•°ç»„ä¸­ç§»é™¤ï¼Œè§¦å‘ v-for æ›´æ–°
  gsItems.value.splice(idx, 1)

  // åˆ é™¤åï¼Œå…¶ä»–å¡ç‰‡å¯èƒ½ä¼šç§»åŠ¨ä½ç½®ï¼ˆfloat: false æ¨¡å¼ä¸‹ä¼šè‡ªåŠ¨å¡«è¡¥ç©ºéš™ï¼‰
  // éœ€è¦åŒæ­¥æœ€æ–°ä½ç½®åˆ° Vue æ•°æ®
  nextTick(() => {
    syncFromGridstack()
  })
}

/**
 * æ¸…ç©ºæ‰€æœ‰å¡ç‰‡
 * åŒ…å«ç¡®è®¤å¯¹è¯æ¡†ï¼Œé˜²æ­¢è¯¯æ“ä½œ
 */
async function clearAllItems() {
  if (gsItems.value.length === 0) return

  // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ ${gsItems.value.length} å¼µå¡ç‰‡å—ï¼Ÿ`)) return

  // ä» GridStack ç§»é™¤æ‰€æœ‰ widget
  if (grid) {
    grid.removeAll(false) // false: ä¸åˆ é™¤ DOM
  }

  // æ¸…ç©º Vue æ•°ç»„ï¼Œè§¦å‘ DOM ç§»é™¤
  gsItems.value = []
}

/**
 * ä¿å­˜å½“å‰å¸ƒå±€åˆ° localStorage
 * 
 * æ‰§è¡Œæ­¥éª¤ï¼š
 * 1. åŒæ­¥ GridStack çŠ¶æ€åˆ° Vue æ•°æ®
 * 2. æå–éœ€è¦æŒä¹…åŒ–çš„å­—æ®µ
 * 3. åºåˆ—åŒ–ä¸º JSON å¹¶å­˜å‚¨
 */
function saveLayout() {
  syncFromGridstack() // ç¡®ä¿ä½ç½®æ•°æ®æ˜¯æœ€æ–°çš„

  // åªä¿å­˜å¿…è¦çš„å­—æ®µï¼Œæ’é™¤è¿è¡Œæ—¶çŠ¶æ€
  const data = gsItems.value.map((it) => ({
    id: it.id,
    x: it.x,
    y: it.y,
    w: it.w,
    h: it.h,
    title: it.title,
    content: it.content,
  }))

  localStorage.setItem(LS_KEY, JSON.stringify(data))
  alert('å·²ä¿å­˜ GridStack ä½ˆå±€')
}

/**
 * ä» localStorage åŠ è½½å¸ƒå±€
 */
async function loadLayout() {
  const raw = localStorage.getItem(LS_KEY)
  const data = safeParseArray(raw)

  if (!data.length) {
    alert('æ‰¾ä¸åˆ°å·²ä¿å­˜çš„ GridStack ä½ˆå±€')
    return
  }

  await reloadLayoutWithData(data)
  alert('å·²è¼‰å…¥ GridStack ä½ˆå±€')
}

/**
 * é‡ç½®ä¸ºé»˜è®¤å¸ƒå±€
 */
async function resetToDefault() {
  await reloadLayoutWithData(defaultLayout)
  alert('å·²é‡ç½®ç‚ºé»˜èªä½ˆå±€')
}

// ============================================================
// ç”Ÿå‘½å‘¨æœŸé’©å­ (Lifecycle Hooks)
// ============================================================

/**
 * ç»„ä»¶æŒ‚è½½ååˆå§‹åŒ–
 * 
 * æ‰§è¡Œæ­¥éª¤ï¼š
 * 1. è®¾ç½®åˆå§‹æ•°æ®
 * 2. æ›´æ–° ID è®¡æ•°å™¨
 * 3. ç­‰å¾… DOM æ¸²æŸ“
 * 4. åˆå§‹åŒ– GridStack å®ä¾‹
 * 5. æ³¨å†Œç°æœ‰ DOM ä¸º widget
 * 6. ç›‘å¬å˜æ›´äº‹ä»¶
 */
onMounted(async () => {
  // æ·±æ‹·è´é»˜è®¤å¸ƒå±€ï¼Œé¿å…ä¿®æ”¹åŸå§‹æ•°æ®
  gsItems.value = defaultLayout.map((it) => ({ ...it }))
  updateCounterFromItems()

  await nextTick() // ç­‰å¾… Vue æ¸²æŸ“ DOM

  // åˆå§‹åŒ– GridStack
  grid = GridStack.init(
    {
      column: 12,                  // ç½‘æ ¼åˆ—æ•°ï¼Œé»˜è®¤ 12 åˆ—
      cellHeight: 80,              // æ¯ä¸ªç½‘æ ¼å•å…ƒçš„é«˜åº¦ï¼ˆåƒç´ ï¼‰
      margin: 10,                  // å¡ç‰‡ä¹‹é—´çš„é—´è·ï¼ˆåƒç´ ï¼‰
      float: false,                // false: å¡ç‰‡ä¼šè‡ªåŠ¨ä¸‹æ²‰å¡«è¡¥ç©ºéš™
                                   // true: å¡ç‰‡å¯ä»¥æµ®åŠ¨ï¼Œä¸‹æ–¹å¯ä»¥æœ‰ç©ºéš™
      disableOneColumnMode: true,  // ç¦ç”¨ç§»åŠ¨ç«¯å•åˆ—æ¨¡å¼
    },
    gridRef.value // æŒ‡å®šå®¹å™¨ DOM å…ƒç´ 
  )

  batchMakeWidgets() // æ³¨å†Œåˆå§‹å¡ç‰‡

  // ç›‘å¬å¡ç‰‡ä½ç½®/å¤§å°å˜åŒ–äº‹ä»¶
  // ç”¨æˆ·æ‹–æ‹½æˆ–è°ƒæ•´å¤§å°åè§¦å‘
  grid.on('change', (event, items) => {
    if (!items) return

    // å°†å˜æ›´åŒæ­¥åˆ° Vue å“åº”å¼æ•°æ®
    items.forEach((node) => {
      const item = gsItems.value.find((it) => it.id === node.id)
      if (item) {
        item.x = node.x
        item.y = node.y
        item.w = node.w
        item.h = node.h
      }
    })
  })
})

/**
 * ç»„ä»¶å¸è½½å‰æ¸…ç†
 * 
 * é‡è¦ï¼šé˜²æ­¢å†…å­˜æ³„æ¼
 * 1. ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
 * 2. é”€æ¯ GridStack å®ä¾‹
 */
onBeforeUnmount(() => {
  if (grid) {
    grid.off('change')     // ç§»é™¤äº‹ä»¶ç›‘å¬
    grid.destroy(false)    // é”€æ¯å®ä¾‹ï¼Œfalse: ä¸ç§»é™¤ DOM
    grid = null            // æ¸…ç©ºå¼•ç”¨
  }
})
</script>

<template>
  <!-- 
    æ•´ä½“å®¹å™¨
    .gridstack-demo: åº”ç”¨åŸºç¡€æ ·å¼ï¼ˆå†…è¾¹è·ã€å­—ä½“ç­‰ï¼‰
  -->
  <div class="gridstack-demo">
    
    <!-- 
      å·¥å…·æ åŒºåŸŸ
      åŒ…å«æ‰€æœ‰æ“ä½œæŒ‰é’®ï¼Œä½¿ç”¨ flexbox å¸ƒå±€
    -->
    <div class="toolbar">
      
      <!-- æ·»åŠ å•ä¸ªå¡ç‰‡æŒ‰é’® -->
      <button class="btn btn-primary" @click="addItem">
        <span class="icon">+</span> æ·»åŠ å¡ç‰‡
      </button>

      <!-- 
        æ‰¹é‡æ·»åŠ åŒºåŸŸ
        åŒ…å«æ•°é‡è¾“å…¥æ¡†å’Œæ‰¹é‡æ·»åŠ æŒ‰é’®
      -->
      <div class="batch-add">
        <!-- 
          v-model.number: åŒå‘ç»‘å®šä¸”è‡ªåŠ¨è½¬ä¸ºæ•°å­—
          min/max: HTML5 åŸç”Ÿé™åˆ¶ï¼ˆä½† JS ä¸­ä»éœ€éªŒè¯ï¼‰
        -->
        <input
          v-model.number="addCount"
          type="number"
          min="1"
          max="20"
          class="count-input"
          placeholder="æ•¸é‡"
        />
        <button class="btn btn-primary-alt" @click="addMultipleItems">
          <span class="icon">++</span> æ‰¹é‡æ·»åŠ 
        </button>
      </div>

      <!-- 
        å¿«é€Ÿæ·»åŠ æŒ‰é’®ç»„
        ä¸€é”®æ·»åŠ å›ºå®šæ•°é‡çš„å¡ç‰‡
      -->
      <div class="quick-add">
        <button class="btn btn-quick" @click="addItems(3)">+3</button>
        <button class="btn btn-quick" @click="addItems(5)">+5</button>
        <button class="btn btn-quick" @click="addItems(10)">+10</button>
      </div>

      <!-- è§†è§‰åˆ†éš”çº¿ -->
      <div class="divider"></div>

      <!-- å¸ƒå±€æ“ä½œæŒ‰é’®ç»„ -->
      <button class="btn btn-success" @click="saveLayout">
        <span class="icon">ğŸ’¾</span> ä¿å­˜ä½ˆå±€
      </button>
      <button class="btn btn-info" @click="loadLayout">
        <span class="icon">ğŸ“‚</span> è¼‰å…¥ä½ˆå±€
      </button>
      <button class="btn btn-warning" @click="resetToDefault">
        <span class="icon">ğŸ”„</span> é‡ç½®é»˜èª
      </button>
      <button class="btn btn-danger" @click="clearAllItems">
        <span class="icon">ğŸ—‘ï¸</span> æ¸…ç©ºå…¨éƒ¨
      </button>
    </div>

    <!-- 
      ç»Ÿè®¡ä¿¡æ¯æ 
      æ˜¾ç¤ºå½“å‰å¡ç‰‡æ€»æ•°
    -->
    <div class="stats">
      ç•¶å‰å¡ç‰‡æ•¸é‡: <strong>{{ gsItems.length }}</strong>
    </div>

    <!-- 
      GridStack ç½‘æ ¼å®¹å™¨
      ref="gridRef": ç”¨äº JavaScript è®¿é—® DOM
      .grid-stack: GridStack åº“è¦æ±‚çš„ç±»å
    -->
    <div ref="gridRef" class="grid-stack">
      
      <!-- 
        å¡ç‰‡å¾ªç¯æ¸²æŸ“
        v-for: æ ¹æ® gsItems æ•°ç»„æ¸²æŸ“å¡ç‰‡
        :key: Vue çš„è™šæ‹Ÿ DOM diff ç®—æ³•éœ€è¦çš„å”¯ä¸€æ ‡è¯†
        
        GridStack å±æ€§è¯´æ˜ï¼š
        - gs-id: å¡ç‰‡å”¯ä¸€æ ‡è¯†ï¼ˆGridStack å†…éƒ¨ä½¿ç”¨ï¼‰
        - gs-x, gs-y: åˆå§‹ä½ç½®åæ ‡
        - gs-w, gs-h: åˆå§‹å®½åº¦å’Œé«˜åº¦
      -->
      <div
        v-for="item in gsItems"
        :key="item.id"
        class="grid-stack-item"
        :gs-id="item.id"
        :gs-x="item.x"
        :gs-y="item.y"
        :gs-w="item.w"
        :gs-h="item.h"
      >
        <!-- 
          å¡ç‰‡å†…å®¹å®¹å™¨
          .grid-stack-item-content: GridStack è¦æ±‚çš„ç±»å
          è¿™ä¸ªå®¹å™¨å†…çš„å†…å®¹å¯ä»¥è‡ªç”±å®šåˆ¶
        -->
        <div class="grid-stack-item-content">
          
          <!-- å¡ç‰‡å¤´éƒ¨ï¼šæ ‡é¢˜å’Œå…³é—­æŒ‰é’® -->
          <div class="card-header">
            <span class="card-title">{{ item.title }}</span>
            <!-- 
              @click.stop: é˜»æ­¢äº‹ä»¶å†’æ³¡
              é˜²æ­¢ç‚¹å‡»å…³é—­æŒ‰é’®æ—¶è§¦å‘å¡ç‰‡çš„æ‹–æ‹½
            -->
            <button
              class="close-btn"
              @click.stop="removeItem(item.id)"
              title="åˆªé™¤å¡ç‰‡"
            >
              Ã—
            </button>
          </div>
          
          <!-- å¡ç‰‡ä¸»ä½“ï¼šæ˜¾ç¤ºå†…å®¹æˆ–å ä½æç¤º -->
          <div class="card-body">
            <p v-if="item.content">{{ item.content }}</p>
            <p v-else class="placeholder">æ‹–æ›³èª¿æ•´ä½ç½®å’Œå¤§å°</p>
          </div>
          
          <!-- 
            å¡ç‰‡åº•éƒ¨ï¼šæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            æ˜¾ç¤º IDã€ä½ç½®åæ ‡å’Œå°ºå¯¸
            ?? '-': ç©ºå€¼åˆå¹¶ï¼Œæœªè®¾ç½®æ—¶æ˜¾ç¤º '-'
          -->
          <div class="card-footer">
            <small>
              ID: {{ item.id }} |
              ä½ç½®: ({{ item.x ?? '-' }}, {{ item.y ?? '-' }}) |
              å¤§å°: {{ item.w }}Ã—{{ item.h }}
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
/*
  scoped: æ ·å¼åªä½œç”¨äºå½“å‰ç»„ä»¶
  Vue ä¼šè‡ªåŠ¨æ·»åŠ  data-v-xxx å±æ€§é€‰æ‹©å™¨
*/

/* ============================================
   å®¹å™¨æ ·å¼
   ============================================ */
.gridstack-demo {
  padding: 20px;
  /* ç³»ç»Ÿé»˜è®¤å­—ä½“æ ˆï¼Œç¡®ä¿åœ¨å„å¹³å°æ˜¾ç¤ºè‰¯å¥½ */
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ============================================
   å·¥å…·æ æ ·å¼
   ============================================ */
.toolbar {
  margin-bottom: 20px;
  display: flex;           /* å¼¹æ€§å¸ƒå±€ */
  flex-wrap: wrap;         /* å…è®¸æ¢è¡Œï¼ˆå“åº”å¼ï¼‰ */
  align-items: center;     /* å‚ç›´å±…ä¸­å¯¹é½ */
  gap: 10px;               /* å­å…ƒç´ é—´è· */
}

/* æ‰¹é‡æ·»åŠ åŒºåŸŸ */
.batch-add {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* æ•°é‡è¾“å…¥æ¡† */
.count-input {
  width: 60px;
  padding: 10px 8px;
  border: 2px solid #667eea;
  border-radius: 6px;
  font-size: 14px;
  text-align: center;
  outline: none;           /* ç§»é™¤é»˜è®¤èšç„¦è½®å»“ */
}

/* è¾“å…¥æ¡†èšç„¦çŠ¶æ€ */
.count-input:focus {
  border-color: #764ba2;
  /* æ·»åŠ æŸ”å’Œçš„å¤–å‘å…‰æ•ˆæœ */
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

/* å¿«é€Ÿæ·»åŠ æŒ‰é’®ç»„ */
.quick-add {
  display: flex;
  gap: 4px;
}

/* å¿«é€Ÿæ·»åŠ æŒ‰é’®æ ·å¼ */
.btn-quick {
  padding: 10px 14px;
  /* æ¸å˜èƒŒæ™¯ */
  background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  color: #333;
  font-weight: 600;
}

/* å‚ç›´åˆ†éš”çº¿ */
.divider {
  width: 1px;
  height: 36px;
  background: #ddd;
  margin: 0 5px;
}

/* ============================================
   ç»Ÿè®¡ä¿¡æ¯æ 
   ============================================ */
.stats {
  margin-bottom: 15px;
  padding: 10px 15px;
  background: #f0f4f8;
  border-radius: 8px;
  font-size: 14px;
  color: #555;
}

.stats strong {
  color: #667eea;
  font-size: 18px;
}

/* ============================================
   æŒ‰é’®åŸºç¡€æ ·å¼
   ============================================ */
.btn {
  padding: 10px 18px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;                /* å›¾æ ‡å’Œæ–‡å­—é—´è· */
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: all 0.2s;    /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
}

/* æŒ‰é’®æ‚¬åœæ•ˆæœ */
.btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);  /* è½»å¾®ä¸Šæµ® */
}

/* æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
.btn:active {
  transform: translateY(0);     /* æ¢å¤åŸä½ */
}

/* ============================================
   æŒ‰é’®é¢œè‰²å˜ä½“ï¼ˆä½¿ç”¨æ¸å˜èƒŒæ™¯ï¼‰
   ============================================ */
.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-primary-alt {
  background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
  color: white;
}

.btn-success {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  color: white;
}

.btn-info {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
}

.btn-warning {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
  color: white;
}

.icon {
  font-size: 16px;
}

/* ============================================
   GridStack ç½‘æ ¼å®¹å™¨
   ============================================ */
.grid-stack {
  /* æ¸å˜èƒŒæ™¯è®©ç½‘æ ¼åŒºåŸŸæ›´æ˜æ˜¾ */
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
  min-height: 500px;       /* æœ€å°é«˜åº¦ */
  border-radius: 12px;
  padding: 10px;
}

/* ============================================
   å¡ç‰‡å†…å®¹å®¹å™¨
   ============================================ */
.grid-stack-item-content {
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);  /* æŸ”å’Œé˜´å½± */
  display: flex;
  flex-direction: column;  /* å‚ç›´å¸ƒå±€ */
  overflow: hidden;        /* è£å‰ªè¶…å‡ºéƒ¨åˆ† */
  height: 100%;            /* å¡«æ»¡çˆ¶å®¹å™¨ */
}

/* ============================================
   å¡ç‰‡å¤´éƒ¨
   ============================================ */
.card-header {
  display: flex;
  justify-content: space-between;  /* ä¸¤ç«¯å¯¹é½ */
  align-items: center;
  padding: 12px 15px;
  /* æ¸å˜èƒŒæ™¯ */
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.card-title {
  font-weight: 600;
  font-size: 14px;
}

/* å…³é—­æŒ‰é’® */
.close-btn {
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 50%;      /* åœ†å½¢ */
  background: rgba(255, 255, 255, 0.2);
  color: white;
  font-size: 18px;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

/* å…³é—­æŒ‰é’®æ‚¬åœ */
.close-btn:hover {
  background: rgba(255, 100, 100, 0.9);  /* çº¢è‰²è­¦ç¤º */
}

/* ============================================
   å¡ç‰‡ä¸»ä½“
   ============================================ */
.card-body {
  flex: 1;                 /* å æ®å‰©ä½™ç©ºé—´ */
  padding: 15px;
  color: #333;
  overflow: auto;          /* å†…å®¹è¿‡å¤šæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
}

.card-body p {
  margin: 0;
}

/* å ä½æç¤ºæ–‡å­— */
.placeholder {
  color: #999;
  font-style: italic;
}

/* ============================================
   å¡ç‰‡åº•éƒ¨
   ============================================ */
.card-footer {
  padding: 8px 15px;
  background: #f8f9fa;
  border-top: 1px solid #eee;
  color: #888;
  font-size: 11px;
}
</style>
